<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>
        <!-- Contract Form View -->
        <record id="view_contract_form" model="ir.ui.view">
            <field name="name">contract.form</field>
            <field name="model">contract</field>
            <field name="arch" type="xml">
                <form string="Energy Trading Contract">
                <header>
                    <button name="activate_contract" string="Activate Contract" type="object"
                        attrs="{'invisible' : [('status', '!=', 'initial')]}"/>
                    <button name="finish_contract" string="Finish Contract" type="object"
                        attrs="{'invisible' : [('status', '!=', 'executing')]}"/>
                    <button string="Distribute Energy" type="action"
                            name="%(action_wizard_energy_distribution)d"
                            attrs="{'invisible': ['|', ('is_transit', '=', True), ('status', '!=', 'executing')]}"
                            context="{'default_contract_id': id, 'default_delivery_point_id': delivery_point_id, 'contract_type': position}"
                            class="oe_highlight"/>
                    <field name="status" widget="statusbar" options="{'clickable': '1'}" statusbar_visible="initial,executing,finished"/>
                </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box" groups="base.group_user">
                            <button name="action_open_transit_contracts"
                                    attrs="{'invisible': [('is_transit', '=', True)]}"
                                    type="object" class="oe_stat_button" icon="fa-refresh" >
                                <span class="o_stat_text">
                                    Transit
                                </span>
                            </button>
                            <button name="%(energy.action_distribution_order_lines)d"
                                    attrs="{'invisible': [('is_transit', '=', True)]}"
                                    type="action" class="oe_stat_button" icon="fa-line-chart">
                                <span class="o_stat_text">
                                    Distributions
                                </span>
                            </button>
                        </div>
                        <group col="2">
                            <group>
                                <field name="category"/>
                                <field name="type"/>
                                <field name="position"/>
                                <field name="master_contract_id" attrs="{'invisible': [('is_transit', '!=', False)]}"/>
                                <field name="parent_contract_id" attrs="{'invisible': [('is_transit', '=', False)]}"/>
                            </group>
                            <group>
                                <field name="name"/>
                                <field name="is_transit"/>
                                <field name="start_date"/>
                                <field name="end_date" attrs="{'invisible': [('is_transit', '!=', False)]}"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Power and Value" attrs="{'invisible': [('is_transit', '!=', False)]}">
                                <group col="2">
                                    <group>
                                       <field name="power" string="Power Per Time/Unit"/>
                                        <field name="powerUnit" string="Power Unit"/>
                                        <field name="timeUnit" string="Time Unit"/>
                                    </group>
                                    <group>
                                        <field name="total_contract_power" string="Total Contract Power"/>
                                        <field name="total_contract_value" string="Total Contract Value - no VAT"/>
                                        <field name="vat" string="VAT"/>
                                        <field name="total_contract_value_with_vat" string="Total Contract Value - with VAT"/>
                                    </group>
                                </group>
                            </page>
                            <page string="Delivery" attrs="{'invisible': [('is_transit', '!=', False)]}">
                                <group>
                                    <field name="delivery_point_id"
                                           attrs="{'required': [('is_transit', '=', False)]}"
                                           string="Delivery Point"/>
                                </group>
                            </page>
                            <page string="Price" attrs="{'invisible': [('is_transit', '!=', False)]}">
                                <group>
                                    <field name="price" string="Price per time unit "  />
                                </group>
                                <field name="contract_price_ids" string="Price Components"  >
                                <tree editable="bottom">
                                <field name="priceComponents_id"/>
                                <field name="unit"/>
                                <field name="value"/>
                                </tree>
                                </field>
                            </page>
                            <page string="LoadShape" attrs="{'invisible': [('is_transit', '!=', False)]}">
                                <group col="2">
                                 <group>
                                    <field name="profile_id" string="Profile"/>
                                    <field name="period_id" string="Period"/>
                                </group>
                                <group>
                                    <field name="excel_file" string="Select Loadshape file"/>
                               </group>
                                </group>
                                <field name="loadshape_details_ids" >
                                    <tree  >
                                    <field name="powerdate"/>
                                    <field name="powerhour"/>
                                    <field name="power" sum="power_total"/>
                                    <!-- other fields -->
                                    </tree>
                                </field>
                            </page>
                            <page string="Distributions" attrs="{'invisible': [('is_transit', '=', False)]}">
                                <field name="distribution_order_ids" widget="one2many">
                                    <tree>
                                        <field name="power_date"/>
                                        <field name="power_hour"/>
                                        <field name="total_power" sum="total_power"/>
                                        <field name="distributed_power" sum="distributed_power"/>
                                        <field name="actual_power" sum="actual_power"/>
                                        <field name="distribution_line_ids" string="Distributions"  mode="tree"
                                               widget="many2many_tags" options="{'no_create': True}" >
                                            <tree>
                                                <field name="power_hour"/>
                                                <field name="delivery_point_id"/>
                                                <field name="power"/>
                                            </tree>
                                        </field>
                                    </tree>
                                </field>
                            </page>
                            <page string="Payment Terms" attrs="{'invisible': [('is_transit', '!=', False)]}">
                                <group>
                                 <field name="payment_terms_id" string="Payment Terms"/>
                                </group>
                            </page>
                            
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- Contract Tree View -->
        <record id="view_contract_tree" model="ir.ui.view">
            <field name="name">contract.tree</field>
            <field name="model">contract</field>
            <field name="arch" type="xml">
                <tree>
                    <field name="name"/>
                    <field name="start_date"/>
                    <field name="end_date"/>
                    <field name="is_transit"/>
                </tree>
            </field>
        </record>

        <!-- Contract Search View -->
        <record id="view_contract_search" model="ir.ui.view">
            <field name="name">contract.search</field>
            <field name="model">contract</field>
            <field name="arch" type="xml">
                <search>
                    <field name="name" string="Contract Name"/>
                    <field name="is_transit"/>
                </search>
            </field>
        </record>
        <!-- Contract Action -->
        <record id="action_contract" model="ir.actions.act_window">
            <field name="name">Energy Trading Contracts</field>
            <field name="res_model">contract</field>
            <field name="view_mode">tree,form</field>
        </record>
        <record model="ir.actions.server" id="action_import_excel">
            <field name="name">Import Loadshape</field>
            <field name="model_id" ref="model_contract"/>
            <field name="binding_model_id" ref="model_contract"/>
            <field name="state">code</field>
            <field name="code">
                action = records.action_import_excel()
            </field>
        </record>
        <record id="action_loadshape_details" model="ir.actions.act_window">
            <field name="name">Loadshape Grouped</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">loadshape_details</field>
            <field name="binding_model_id" ref="model_contract"/>
            <field name="view_mode">tree,form</field>
            <field name="context">{'group_by': 'powerdate'}</field>
        </record>
         <record model="ir.actions.server" id="action_delete_detail">
            <field name="name">Delete Loadshape</field>
            <field name="model_id" ref="model_contract"/>
            <field name="binding_model_id" ref="model_contract"/>
            <field name="state">code</field>
            <field name="code">
                action = records.action_delete_detail()
            </field>
        </record>
    </data>
</odoo>
